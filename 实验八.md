## 研究背景

**研究对象：**`BiliBili`评论区出现的，对于爬虫，爬取网站数据，一般目的都是比较明确的，比如我这里就是为了研究评论，废话不多说，开干！ 

**研究的背景：**

**意义：**




主要的文件为：

- check.text: 观察请求评论区数据的`url`请求包，得到请求规律
- 



#### Python环境

- Python3.9

- pandas
- numpy
- scrapy
- PyCharm

 

## 数据获取

### 数据获取方式

通过爬虫爬取获取数据

![](../img/1.png)

**相关理论：**首先打开浏览器，进入哔哩哔哩，打开一个视频。打开开发者工具，清除数据包后，向下拖动评论区可以发现哔哩哔哩的评论区采用的是懒加载模式。浏览器发送`GET`请求，服务器收到请求后返回数据一次返回固定的长度。当页面显示的长度大于浏览器返回包的长度时进行懒加载一次，加载一次浏览器发送一次`GET`请求，服务器返回一次数据，返回了数据里 `res.data`包括了评论区里面的真实回答。找到这些回答的包以后，删除相应包的参数，可以发现请求的浏览器发出的请求的`url`，将`url`复制到筛选框内，筛选对应的包，可以找到所有请求评论评论的所有`url`。通过抓包分析到三个`url`即可得到请求评论区数据的请求包规律。 

![](../img/2.png)

**确定到的请求网址**

`start_url = https://api.bilibili.com/x/v2/reply/main?jsonp=jsonp&next={}&type=1&oid=507855067&mode=3&plat=1&_=1650361573280`



## 数据探索

### 数据基本信息

（简要介绍数据的基本信息，如数据文件类型，包含的内容等等）

`replies`为有逻辑编号的列表，

![](../img/3.png)

需要的数据在`replies[0].content.message`

![](../img/4.png)

一级评论：https://api.bilibili.com/x/v2/reply/main?jsonp=jsonp&next=0&type=1&oid=208143004&mode=3&plat=1

        next：翻页
        oid：视频编号（aid）
        mode：1、2表示按热度、时间排序;  0、3表示按热度排序，并显示评论和用户信息
二级评论：https://api.bilibili.com/x/v2/reply/reply?jsonp=jsonp&pn=1&type=1&oid=208143004&ps=10&root=5453611704

        pn：翻页
        oid：视频oid
        root：楼主的回复的rpid
        ps: 单页显示数量（最大为20）


### 数据读取

读取数据使用了`requests.get`函数。通过`requests.get(url, headers)`构造一个向服务器请求资源的url对象。这个对象是手动生成的。这时候的r返回的是一个包含服务器资源的Response对象。包含从服务器返回的所有的相关资源。

**获取数据代码：**

```python
def main():
        print('爬取懒加载节点{}的数据!'.format(i))
        start_url = f'https://api.bilibili.com/x/v2/reply/main?jsonp=jsonp&next=1&type=1&oid=507855067&mode=3&plat=1&_=1650361573280'
        headers = {
            'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.88 Safari/537.36',
            'referer': 'https://www.bilibili.com/video/BV1Zu411m72m?spm_id_from=333.999.0.0'
        }
        response = requests.get(start_url, headers = headers).json()
        ic(response)
```

由于本机的`cmd`的下载会调入`Acaconda`模块，而`vscode`的控制台会调用此处`C:\Python310\python.exe`，需要手动加`Acaconda`路径，或者将`Acaconda`的环境变量暴露出去，就可以解决该问题

```cmd
&D:\Data\Acaconda\python.exe D:\Study\course\Python\NO8\get_data.py
```



## 数据清洗与预处理

提取`replies.message`内容，该内容即为评论信息

 ```python
replies = jsonpath(response,'$..replies')
message_list = jsonpath(replies,'$..message')
 ```



## 数据分析及可视化

```python
def parse_img(big_list):
    print('----------词云生成中------------')
    data = ''.join(big_list)
    stylecloud.gen_stylecloud(data,font_path="C:/Windows/Fonts/simfang.ttf")
    img = Image.open("D:/Study/course/Python/NO8/stylecloud.png")
    img.show()
    print('----------词云已生成------------')
```



## 心得体会

 





学生签字：手写

提交日期：2022年04月20日